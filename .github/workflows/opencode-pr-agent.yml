name: OpenCode PR Agent

on:
  pull_request:
    types: [opened, assigned, synchronize]
  issue_comment:
    types: [created]

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  opencode-agent:
    runs-on: ubuntu-latest
    # Only run on PRs, not on issues
    if: github.event_name == 'pull_request' || (github.event_name == 'issue_comment' && github.event.issue.pull_request)
    
    steps:
      - name: Check if OpenCode should run
        id: should_run
        run: |
          echo "Checking if OpenCode should run..."
          
          # Run on PR open/assign
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            if [ "${{ github.event.action }}" == "opened" ] || [ "${{ github.event.action }}" == "assigned" ]; then
              echo "run=true" >> $GITHUB_OUTPUT
              echo "Trigger: PR ${{ github.event.action }}"
            else
              echo "run=false" >> $GITHUB_OUTPUT
            fi
          fi
          
          # Run on comment with @opencode mention
          if [ "${{ github.event_name }}" == "issue_comment" ]; then
            if echo "${{ github.event.comment.body }}" | grep -q "@opencode"; then
              echo "run=true" >> $GITHUB_OUTPUT
              echo "Trigger: @opencode mention in comment"
            else
              echo "run=false" >> $GITHUB_OUTPUT
            fi
          fi

      - name: Checkout PR branch
        if: steps.should_run.outputs.run == 'true'
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.ref }}
          repository: ${{ github.event.pull_request.head.repo.full_name }}
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Setup Node.js
        if: steps.should_run.outputs.run == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        if: steps.should_run.outputs.run == 'true'
        run: npm ci

      - name: Install OpenCode CLI
        if: steps.should_run.outputs.run == 'true'
        run: |
          npm install -g @opencode/cli
          opencode --version

      - name: Configure Git
        if: steps.should_run.outputs.run == 'true'
        run: |
          git config --global user.name "OpenCode Bot"
          git config --global user.email "opencode-bot@users.noreply.github.com"

      - name: Run OpenCode Agent
        if: steps.should_run.outputs.run == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          OPENCODE_AI_PROVIDER: copilot
        run: |
          # Get PR details
          PR_NUMBER="${{ github.event.pull_request.number }}"
          PR_TITLE="${{ github.event.pull_request.title }}"
          PR_BODY="${{ github.event.pull_request.body }}"
          PR_AUTHOR="${{ github.event.pull_request.user.login }}"
          
          # Check if this is a comment trigger
          if [ "${{ github.event_name }}" == "issue_comment" ]; then
            COMMENT_BODY="${{ github.event.comment.body }}"
            echo "Comment trigger detected: $COMMENT_BODY"
            
            # Extract instruction after @opencode
            INSTRUCTION=$(echo "$COMMENT_BODY" | sed 's/.*@opencode *//')
            
            # Run OpenCode with the instruction
            echo "Running OpenCode with instruction: $INSTRUCTION"
            opencode "$INSTRUCTION"
            
          else
            # For new PRs or assignments, analyze and triage
            echo "PR #$PR_NUMBER: $PR_TITLE"
            echo "Author: $PR_AUTHOR"
            echo "Description: $PR_BODY"
            
            # Determine action based on PR state
            if [ "${{ github.event.action }}" == "opened" ]; then
              # Triage new PR
              opencode "Triage this PR. Review the changes, run tests, check for issues, and provide feedback as a PR comment. If there are test failures or build issues, attempt to fix them."
            elif [ "${{ github.event.action }}" == "assigned" ]; then
              # Implement assigned PR
              opencode "This PR has been assigned. Read the PR description and implement the requested changes. Follow the spec-driven development process in AGENTS.md. Create a spec if one doesn't exist, implement the feature, write tests, and ensure the build passes."
            fi
          fi

      - name: Run Tests
        if: steps.should_run.outputs.run == 'true'
        run: |
          npm test || echo "Tests failed - OpenCode should have addressed this"

      - name: Build Project
        if: steps.should_run.outputs.run == 'true'
        run: |
          npm run build || echo "Build failed - OpenCode should have addressed this"

      - name: Commit and Push Changes
        if: steps.should_run.outputs.run == 'true'
        run: |
          # Check if there are changes to commit
          if [[ -n $(git status -s) ]]; then
            git add .
            git commit -m "OpenCode: Automated changes from PR agent
            
            Triggered by: ${{ github.event_name }}
            Action: ${{ github.event.action }}
            PR: #${{ github.event.pull_request.number }}"
            
            git push origin ${{ github.event.pull_request.head.ref }}
            
            echo "Changes committed and pushed"
          else
            echo "No changes to commit"
          fi

      - name: Comment on PR
        if: steps.should_run.outputs.run == 'true' && success()
        uses: actions/github-script@v7
        with:
          script: |
            const pr_number = context.payload.pull_request.number;
            const message = `✅ OpenCode has processed this PR.
            
            **Actions taken:**
            - Reviewed changes
            - Ran tests and build
            - Applied any necessary fixes
            
            Please review the changes and let me know if you need any adjustments by mentioning @opencode in a comment.`;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr_number,
              body: message
            });

      - name: Comment on failure
        if: steps.should_run.outputs.run == 'true' && failure()
        uses: actions/github-script@v7
        with:
          script: |
            const pr_number = context.payload.pull_request.number;
            const message = `⚠️ OpenCode encountered an issue while processing this PR.
            
            Please check the [workflow run logs](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}) for details.
            
            You can try again by mentioning @opencode with specific instructions.`;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr_number,
              body: message
            });
