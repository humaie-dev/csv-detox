# Spec: Preview UI and Pipeline Builder
Date: 2026-02-03
ID: 003c
Status: Done
Completion Date: 2026-02-03

## Objective
Build the React UI components for displaying parsed CSV/Excel data, previewing transformation results, and building transformation pipelines using shadcn/ui components. Create an interactive interface where users can see their data and configure transformations step-by-step.

## Scope
### In scope
- Data table component for displaying ParseResult data with column metadata
- Pipeline builder UI with step list and controls
- Transformation configuration forms for all 7 operations
- Step-by-step preview (execute pipeline up to selected step)
- Add/remove/reorder pipeline steps
- Basic error display for validation failures
- shadcn/ui component integration (Table, Card, Button, Dialog, Select, Input)
- Client-side state management for pipeline editing
- Integration with Convex mutations/queries from spec 003b

### Out of scope
- Advanced data grid features (virtual scrolling, column resizing, sorting, filtering)
- Drag-and-drop for reordering steps (manual up/down buttons sufficient)
- Undo/redo functionality (future spec)
- Pipeline saving/loading (covered by spec 003b Convex integration)
- Export functionality (future spec)
- Real-time collaboration (future spec)
- Performance optimization for large datasets (future spec)

## Requirements
### Functional
- FR1: Display parsed table data with rows and column metadata (name, type, nullCount)
- FR2: Show pipeline steps in a list with step type and configuration summary
- FR3: Add new transformation steps via dropdown/dialog with operation selection
- FR4: Configure each operation type with appropriate form fields
- FR5: Remove individual steps from pipeline
- FR6: Reorder steps with up/down buttons
- FR7: Preview data at any step (execute pipeline up to that step)
- FR8: Display transformation errors inline when step execution fails
- FR9: Show row count changes after each step (e.g., "100 → 95 rows")
- FR10: Highlight currently selected/previewed step

### Non-functional
- NFR1: Use shadcn/ui components as base (Table, Card, Button, Dialog, Select, Input)
- NFR2: Responsive layout (works on desktop, acceptable on tablet)
- NFR3: TypeScript strict mode with proper types
- NFR4: Server components by default, "use client" only when needed
- NFR5: Accessible UI (proper labels, keyboard navigation)
- NFR6: Fast preview updates (<500ms for small datasets)
- NFR7: Clear visual feedback for loading states

## Implementation Plan

### Phase 1: Data Table Component
1. Install shadcn/ui components:
   - `npx shadcn@latest add table`
   - `npx shadcn@latest add card`
2. Create `src/components/DataTable.tsx`
   - Display ParseResult data in Table component
   - Show column headers with type badges
   - Display first 100 rows (pagination in future spec)
   - Show row count and column count summary

### Phase 2: Pipeline Step List
3. Install additional shadcn/ui components:
   - `npx shadcn@latest add button`
   - `npx shadcn@latest add badge`
4. Create `src/components/PipelineSteps.tsx`
   - List of pipeline steps with operation type
   - Configuration summary for each step
   - Up/down/remove buttons per step
   - Highlight selected step

### Phase 3: Add Step Dialog
5. Install dialog components:
   - `npx shadcn@latest add dialog`
   - `npx shadcn@latest add select`
   - `npx shadcn@latest add input`
   - `npx shadcn@latest add label`
6. Create `src/components/AddStepDialog.tsx`
   - Dialog with operation type selector
   - Dynamic form based on selected operation
   - Form components for each operation config:
     - Trim: column selector (multi-select)
     - Uppercase/Lowercase: column selector (multi-select)
     - Deduplicate: optional column selector (multi-select)
     - Filter: column selector, operator dropdown, value input
     - Rename Column: old name input, new name input
     - Remove Column: column selector (multi-select)
   - Validation before adding step

### Phase 4: Pipeline Preview Page
7. Create `src/app/preview/[uploadId]/page.tsx`
   - Fetch upload metadata and parsed data
   - Load/create pipeline from Convex
   - Display DataTable with current preview
   - Display PipelineSteps
   - Wire up preview execution (executeUntilStep)
   - Show loading states during execution
   - Display execution errors

### Phase 5: Integration and State Management
8. Implement client-side state for pipeline editing
   - Track current pipeline steps
   - Track selected step index for preview
   - Optimistic updates for add/remove/reorder
   - Sync with Convex mutations
9. Connect to Convex backend:
   - Use `useMutation` for createPipeline, updatePipeline
   - Use `useQuery` for getPipeline
   - Call executePipelineAction for preview

## Testing Plan

### Unit Tests
- Not required for UI components in this spec (integration/manual testing sufficient)
- Future: Add React Testing Library tests for complex form logic

### Integration Tests
- Manual testing with Convex dev environment:
  1. Upload a CSV file via existing upload page
  2. Navigate to preview page with uploadId
  3. Verify data table displays correctly
  4. Add transformation steps (one of each type)
  5. Verify preview updates after each step
  6. Remove steps and verify preview reverts
  7. Reorder steps and verify preview reflects new order
  8. Test error handling (e.g., filter on non-existent column)
  9. Test with different file types (CSV, Excel with multiple sheets)

### Manual Testing Scenarios
- **Empty file**: Verify graceful handling
- **Large file (1000+ rows)**: Verify table displays first 100 rows
- **All transformations**: Test each operation type with various configs
- **Error recovery**: Break a step config, verify error display, fix it
- **Multiple sheets**: Verify sheet selection (if Excel file)

## Acceptance Criteria
- AC1: DataTable displays parsed data with column types and row count
- AC2: User can add transformation steps via dialog with operation selection
- AC3: User can configure each operation type with appropriate form inputs
- AC4: User can remove steps from pipeline
- AC5: User can reorder steps with up/down buttons
- AC6: Preview updates when selecting different steps in pipeline
- AC7: Errors display clearly when step execution fails
- AC8: Row count changes visible after each transformation
- AC9: Pipeline state persists in Convex database
- AC10: All shadcn/ui components properly styled and accessible

## Technical Notes

### Component Structure
```
src/
  components/
    ui/                    # shadcn/ui components (auto-generated)
      table.tsx
      card.tsx
      button.tsx
      dialog.tsx
      select.tsx
      input.tsx
      label.tsx
      badge.tsx
    DataTable.tsx          # Main data display component
    PipelineSteps.tsx      # Step list with controls
    AddStepDialog.tsx      # Dialog for adding new steps
    OperationConfigForm.tsx # Dynamic form for operation configs
  app/
    preview/
      [uploadId]/
        page.tsx           # Main preview page
```

### State Management
- Use React useState/useReducer for local pipeline editing state
- Optimistic updates: Update UI immediately, sync to Convex in background
- Use Convex queries for initial load and subscriptions
- Use Convex mutations for persistence

### Data Flow
1. Page loads → fetch upload + parse data (Convex query/action)
2. Page loads → fetch pipeline if exists (Convex query)
3. User adds step → update local state → save to Convex
4. User selects step → execute pipeline up to step → update preview
5. Preview updates → call executePipelineAction with uploadId + steps + stopAtIndex

## Future Enhancements (Out of Scope)
- Virtual scrolling for large datasets
- Column sorting and filtering in data table
- Drag-and-drop step reordering
- Bulk step operations (duplicate, disable)
- Pipeline templates and presets
- Export functionality
- Advanced validation with inline error indicators per field
