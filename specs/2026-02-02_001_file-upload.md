# Spec: File Upload for CSV/Excel Files
Date: 2026-02-02
ID: 001
Status: Done

## Objective
Enable users to upload CSV or Excel (.xlsx) files to CSV Detox. Files are stored using Convex file storage, with metadata tracked in Postgres (via Convex). File IDs are generated by the database.

## Scope
### In scope
- Upload UI component on the home page
- Convex mutations to handle file uploads
- Convex file storage for actual file data
- Postgres (via Convex) for file metadata storage
- File validation (type, size)
- Basic security measures (filename sanitization, file type checking)
- Database-generated unique file identifiers
- Response with upload metadata (file ID, original filename, size, type)

### Out of scope
- File parsing/preview (separate spec)
- Transformation pipeline execution
- TTL-based cleanup (will be added in a future spec)
- Multi-file batch uploads
- Progress indicators for large files
- Resumable uploads

## Requirements
### Functional
- FR1: User can click a button or drag-and-drop to select a file
- FR2: System accepts .csv and .xlsx file types only
- FR3: System rejects files larger than 50MB
- FR4: Database (Postgres via Convex) generates a unique ID for each uploaded file
- FR5: System stores file in Convex file storage
- FR6: System stores metadata in Postgres: `{ id (generated), originalName, sanitizedName, size, mimeType, convexStorageId, uploadedAt }`
- FR7: System returns upload metadata: `{ fileId, originalName, size, mimeType, uploadedAt }`
- FR8: Client displays upload success state with file metadata

### Non-functional
- NFR1: File validation happens before accepting the upload
- NFR2: Filenames are sanitized to prevent directory traversal attacks
- NFR3: MIME type is verified (not just extension)
- NFR4: Convex file storage provides appropriate access controls
- NFR5: Upload completes within 10 seconds for files up to 50MB

## Implementation Plan
1. Set up Convex:
   - Install Convex SDK (`npm install convex`)
   - Initialize Convex project (`npx convex dev`)
   - Configure Postgres integration in Convex
2. Create database schema in `convex/schema.ts`:
   - Define `uploads` table with columns: id (generated), originalName, sanitizedName, size, mimeType, convexStorageId, uploadedAt
3. Create Convex mutations in `convex/uploads.ts`:
   - `uploadFile` mutation: validates, stores file in Convex storage, creates DB record
4. Create upload UI component in `src/app/page.tsx`
   - File input with accept attribute for .csv and .xlsx
   - Drag-and-drop zone
   - Display upload state (idle, uploading, success, error)
   - Use Convex React hooks to call mutations
5. Create utility functions in `src/lib/upload.ts`
   - `sanitizeFilename(filename: string): string`
   - `validateFileType(filename: string, mimeType: string): boolean`
   - `validateFileSize(size: number): boolean`
6. Add Convex provider to `src/app/layout.tsx`

## Testing Plan
- Unit:
  - Test `sanitizeFilename` with various malicious filenames
  - Test `validateFileType` with valid and invalid file types
  - Test `validateFileSize` with various sizes
- Integration:
  - Test Convex mutation with valid CSV file
  - Test Convex mutation with valid XLSX file
  - Test rejection of invalid file types
  - Test rejection of oversized files
  - Test file is stored in Convex storage and metadata in Postgres
  - Test database generates sequential or unique IDs
- Manual:
  - Upload a 1KB CSV file
  - Upload a 10MB XLSX file
  - Try uploading a .txt file (should fail)
  - Try uploading a 51MB file (should fail)
  - Verify file metadata appears in Postgres
  - Verify file is accessible via Convex storage ID

## Acceptance Criteria
- AC1: User can select a CSV or XLSX file via file picker
- AC2: User can drag-and-drop a CSV or XLSX file onto the upload zone
- AC3: System rejects non-CSV/XLSX files with clear error message
- AC4: System rejects files over 50MB with clear error message
- AC5: Successful upload displays file metadata to user including DB-generated file ID
- AC6: Uploaded file is stored in Convex file storage
- AC7: File metadata is stored in Postgres with DB-generated ID
- AC8: Convex storage ID is recorded in the database for file retrieval
- AC9: No security vulnerabilities (directory traversal, arbitrary file execution)
