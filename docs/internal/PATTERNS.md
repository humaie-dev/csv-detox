# Pattern Registry (Internal)

Record coding/architectural patterns used in CSV Detox.
Update only after asking and receiving approval for new patterns/libraries.

## Current patterns

### Folder conventions
- `src/lib/**` contains pure logic
- `src/app/**` contains Next.js App Router pages and layouts
- `convex/**` contains Convex backend code (schema, mutations, queries)

### Backend: Convex + Postgres
- **Convex** is used as the backend-as-a-service platform
- **Convex file storage** stores uploaded files (CSV/XLSX)
- **Database**: Convex's built-in document database stores metadata
- **Postgres integration**: Available via Convex dashboard for future relational features
- File IDs are generated by the Convex database (not client-side UUIDs)

### File Upload Pattern
- Client calls `generateUploadUrl` mutation to get upload URL
- Client uploads file directly to Convex storage
- Client calls `uploadFile` mutation with storage ID + metadata
- Mutation validates file and stores metadata in database
- All validation logic lives in Convex mutations (server-side)

### React Integration
- `ConvexProvider` wraps the app in `layout.tsx`
- Pages use `useMutation` and `useQuery` hooks from `convex/react`
- All Convex functions are strongly typed via generated API (`convex/_generated/api`)

### Testing Patterns
- **Framework**: Node.js built-in test runner with tsx for TypeScript support
- **Test location**: `__tests__` directories next to the code being tested
- **Test naming**: `*.test.ts` files
- **Unit tests**: Pure functions in `src/lib/**` are unit tested in isolation
- **Integration tests**: Convex mutations tested using Convex test helpers (future)
- **Run tests**: `npm test` - runs all tests, exits with code 0 on success
- **Watch mode**: `npm run test:watch` - reruns tests on file changes
- **Coverage**: All validation logic must have >90% test coverage
- **Test structure**: Use `describe` for grouping, `it` for individual tests
- **Assertions**: Use Node's built-in `assert` module

### Planned
- DuckDB for preview/export execution patterns (to be documented when implemented)
- Authorization approach (to be documented when introduced)
