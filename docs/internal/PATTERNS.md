# Pattern Registry (Internal)

Record coding/architectural patterns used in CSV Detox.
Update only after asking and receiving approval for new patterns/libraries.

---

## Table of Contents

- [Folder Conventions](#folder-conventions)
- [Backend Patterns](#backend-patterns)
- [File Upload Pattern](#file-upload-pattern)
- [React Integration](#react-integration)
- [UI Components (shadcn/ui)](#ui-components-shadcnui)
- [Security Patterns](#security-patterns)
- [Testing Patterns](#testing-patterns)
- [Planned Patterns](#planned-patterns)

---

## Current Patterns

### Folder Conventions

**When to use this pattern**: Every file you create must follow this structure.

| Directory | Purpose | What Goes Here |
|-----------|---------|----------------|
| `src/lib/**` | Pure logic | Parsers, validators, utilities, business logic (no React, no side effects) |
| `src/app/**` | Next.js App Router | Pages, layouts, API routes (thin handlers, delegate to `src/lib/**`) |
| `src/components/ui/**` | shadcn/ui components | Auto-generated UI primitives (Button, Card, Dialog, etc.) |
| `src/components/**` | Application components | App-specific React components (AssistantChat, FileUploader, etc.) |
| `convex/**` | Backend logic | Convex schema, mutations, queries |
| `e2e/**` | E2E tests | Playwright test specs (`*.spec.ts`) |
| `src/lib/__tests__/**` | Unit tests | Co-located tests (`*.test.ts`) next to code being tested |

### Backend Patterns

**When to use this pattern**: All backend interactions use Convex.

- **Convex** is the backend-as-a-service platform
  - **File storage**: Upload files directly to Convex storage (up to 50MB)
  - **Database**: Convex document database stores metadata (uploads, projects, pipelines)
  - **Functions**: Mutations (write), queries (read), actions (HTTP)
  - **IDs**: Generated by Convex database (not client-side UUIDs)
  
- **SQLite** for server-side data processing
  - **Purpose**: Fast preview (≤5,000 rows)
  - **Location**: Server memory (in-memory database)
  - **Lifetime**: Request duration only
  
- **Client-side export** for full file processing
  - **Purpose**: Full file export (unlimited rows)
  - **Location**: Browser memory
  - **Lifetime**: Browser session
  
- **Postgres** available via Convex dashboard for future relational features (not currently used)

### File Upload Pattern

**When to use this pattern**: Every file upload must follow this 3-step process.

**Flow**:
1. Client calls `generateUploadUrl` mutation → Returns upload URL
2. Client uploads file directly to Convex storage (bypass server)
3. Client calls `uploadFile` mutation with storage ID + metadata

**Why this pattern?**
- Direct upload to Convex is faster (no server middleman)
- Validation happens server-side (secure)
- File IDs are database-generated (consistent with Convex patterns)

**Example**:
```typescript
// Step 1: Get upload URL
const uploadUrl = await generateUploadUrl();

// Step 2: Upload file
const response = await fetch(uploadUrl, {
  method: "POST",
  body: file,
});
const { storageId } = await response.json();

// Step 3: Store metadata
await uploadFile({ storageId, name, size, mimeType });
```

### React Integration

**When to use this pattern**: All Convex interactions from React use these hooks.

**Setup**:
- `ConvexProvider` wraps the app in `layout.tsx`
- Strong typing via generated API (`convex/_generated/api`)

**Query Pattern (Read Data)**:
```typescript
import { useQuery } from "convex/react";
import { api } from "@/../convex/_generated/api";

const projects = useQuery(api.queries.getProjects);
// Returns: Projects array | undefined (loading)
```

**Mutation Pattern (Write Data)**:
```typescript
import { useMutation } from "convex/react";
import { api } from "@/../convex/_generated/api";

const createProject = useMutation(api.mutations.createProject);

// Later: await createProject({ name: "My Project", uploadId });
```

**Why this pattern?**
- **Automatic reactivity**: UI updates when data changes
- **Type safety**: TypeScript knows exact types
- **Optimistic updates**: Instant feedback (useMutation)

### UI Components (shadcn/ui)

**When to use this pattern**: All UI primitives come from shadcn/ui.

**Component Library**: shadcn/ui (Tailwind CSS-based, copy-paste components)

**Installation**:
```bash
npx shadcn@latest add <component>
```
Components are copied to `src/components/ui/` (not npm dependencies).

**Philosophy**: Components are **owned by the project**, allowing full customization.

**Common Components**:
| Component | Use Case |
|-----------|----------|
| `button` | Buttons with variants (default, destructive, outline, ghost, link) |
| `card` | Content containers with header/content/footer |
| `dialog` | Modal dialogs |
| `sheet` | Side drawers (like assistant panel) |
| `select` | Dropdown selects |
| `input` | Form inputs |
| `table` | Data tables |
| `toast` | Notifications |

**Pattern**:
1. Install shadcn/ui component as base
2. Compose application-specific components in `src/components/`
3. Customize in `src/components/ui/` if needed

**Example**:
```typescript
import { Button } from "@/components/ui/button";
import { Card } from "@/components/ui/card";

export function MyFeature() {
  return (
    <Card>
      <Button variant="default">Click Me</Button>
    </Card>
  );
}
```

**Documentation**: https://ui.shadcn.com/docs

### Security Patterns

**When to use this pattern**: Always. Security is mandatory in all code.

**Never Log Raw User Data**:

```typescript
// ❌ NEVER log sensitive user data
console.log("Processing file:", fileContents);
console.log("User data:", rawData);

// ✅ Log metadata only
console.log("Processing file:", {
  size: file.size,
  type: file.type,
  name: file.name,
  rowCount: data.length
});
```

**Why this pattern?**
- User CSV/XLSX files may contain PII, financial data, or confidential information
- Logs could be exposed in error tracking, debugging sessions, or cloud logs
- Metadata (size, row count, column names) is sufficient for debugging

**File Upload Validation**:

```typescript
// Always validate on server-side
import { validateFileType, validateFileSize } from "@/lib/validation";

// Client-side validation is for UX only
if (!validateFileType(file)) {
  throw new Error("Invalid file type");
}

if (!validateFileSize(file)) {
  throw new Error("File too large");
}
```

**Input Sanitization**:

```typescript
import { sanitizeFilename } from "@/lib/validation";

// Sanitize user-provided filenames
const safeName = sanitizeFilename(userProvidedName);
```

**Security Checklist**:
- ✅ Never log raw user data (file contents, row data)
- ✅ Validate file types and sizes server-side
- ✅ Sanitize user-provided strings (filenames, column names)
- ✅ Use Convex's built-in authentication when adding auth
- ✅ Keep dependencies updated (check `npm audit`)

**See**: [docs/agent-guides/CODE_STYLE.md](../agent-guides/CODE_STYLE.md#never-log-raw-user-data) for additional security guidelines

### Testing Patterns

**When to use this pattern**: All business logic and user flows must have tests.

**Unit Testing**:
- **Framework**: Node.js built-in test runner + tsx
- **Location**: `__tests__/` directories next to code
- **Naming**: `*.test.ts` files
- **Commands**:
  - `npm test` — Run all tests
  - `npm test <file>` — Run specific test
  - `npm run test:watch` — Watch mode
  
**E2E Testing**:
- **Framework**: Playwright
- **Location**: `e2e/` directory
- **Naming**: `*.spec.ts` files
- **Commands**:
  - `npx playwright test` — Run all E2E tests
  - `npx playwright test --ui` — Interactive mode
  - `npx playwright test --headed` — See browser

**Test Structure**:
```typescript
import { describe, it } from "node:test";
import assert from "node:assert";

describe("Module", () => {
  describe("functionToTest", () => {
    it("should handle normal case", () => {
      assert.strictEqual(result, expected);
    });
  });
});
```

**Coverage Goals**:
- **Business logic**: >90%
- **Utilities**: >95%
- **API routes**: >80%
- **UI components**: Smoke tests + critical paths

**See**: [docs/agent-guides/TESTING.md](../agent-guides/TESTING.md) for comprehensive guide

---

## Planned Patterns

Patterns to be documented when introduced:

- **Authorization approach** (when auth is added)
- **Real-time collaboration** (if multi-user support added)
- **Background job processing** (if needed for large files)
- **CDN integration** (for static assets)

---

## Related Documentation

- **[docs/agent-guides/ARCHITECTURE.md](../agent-guides/ARCHITECTURE.md)** — System architecture
- **[docs/agent-guides/CODE_STYLE.md](../agent-guides/CODE_STYLE.md)** — Coding conventions
- **[docs/agent-guides/COMMON_TASKS.md](../agent-guides/COMMON_TASKS.md)** — Implementation examples
- **[docs/agent-guides/TESTING.md](../agent-guides/TESTING.md)** — Testing guide
